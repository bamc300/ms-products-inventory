events {}

http {
  upstream products_service {
    server products-service:8081;
  }

  upstream inventory_service {
    server inventory-service:8082;
  }

  server {
    listen 8080;

    location = / {
      default_type text/html;
      return 200 '<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Inventory Gateway</title></head><body><h2>Inventory Gateway</h2><ul><li><a href="/products/swagger-ui/index.html">Swagger - Products</a></li><li><a href="/inventory/swagger-ui/index.html">Swagger - Inventory</a></li><li><a href="/products/actuator/health">Health - Products</a></li><li><a href="/inventory/actuator/health">Health - Inventory</a></li></ul><p>Autenticaci√≥n: Bearer Token (JWT)</p></body></html>';
    }

    location ^~ /api/v1/auth {
      proxy_pass http://products_service;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /api/v1/products {
      proxy_pass http://products_service;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /api/v1/inventory {
      proxy_pass http://inventory_service;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /api/v1/purchases {
      proxy_pass http://inventory_service;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /products/v3/api-docs/ {
      proxy_pass http://products_service/v3/api-docs/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types application/json;
      sub_filter '"/v3/api-docs/swagger-config"' '"/products/v3/api-docs/swagger-config"';
      sub_filter '"/v3/api-docs"' '"/products/v3/api-docs"';
      sub_filter '"http://localhost/swagger-ui/oauth2-redirect.html"' '"/products/swagger-ui/oauth2-redirect.html"';
    }

    location = /products/v3/api-docs {
      proxy_pass http://products_service/v3/api-docs;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /products/swagger-ui/ {
      proxy_pass http://products_service/swagger-ui/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types text/html application/javascript text/javascript;
      sub_filter '"/v3/api-docs/swagger-config"' '"/products/v3/api-docs/swagger-config"';
      sub_filter '"/v3/api-docs"' '"/products/v3/api-docs"';
    }

    location /products/ {
      proxy_pass http://products_service/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-API-Key $http_x_api_key;
    }

    location ^~ /inventory/v3/api-docs/ {
      proxy_pass http://inventory_service/v3/api-docs/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types application/json;
      sub_filter '"/v3/api-docs/swagger-config"' '"/inventory/v3/api-docs/swagger-config"';
      sub_filter '"/v3/api-docs"' '"/inventory/v3/api-docs"';
      sub_filter '"http://localhost/swagger-ui/oauth2-redirect.html"' '"/inventory/swagger-ui/oauth2-redirect.html"';
    }

    location = /inventory/v3/api-docs {
      proxy_pass http://inventory_service/v3/api-docs;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    location ^~ /inventory/swagger-ui/ {
      proxy_pass http://inventory_service/swagger-ui/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-API-Key $http_x_api_key;
      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types text/html application/javascript text/javascript;
      sub_filter '"/v3/api-docs/swagger-config"' '"/inventory/v3/api-docs/swagger-config"';
      sub_filter '"/v3/api-docs"' '"/inventory/v3/api-docs"';
    }

    location /inventory/ {
      proxy_pass http://inventory_service/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-API-Key $http_x_api_key;
    }
  }
}
